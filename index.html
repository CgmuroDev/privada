<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Una pregunta para ti</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@500;700&family=EB+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #0a0c0f;
      --bg-card: #111418;
      --gold: #c9a227;
      --gold-light: #e8d48b;
      --gold-dark: #8b6914;
      --text: #d4cfc4;
      --text-muted: rgba(212, 207, 196, 0.6);
      --border: rgba(201, 162, 39, 0.25);
      --glow: rgba(201, 162, 39, 0.15);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'EB Garamond', Georgia, serif;
      background: var(--bg-dark);
      background-image:
        radial-gradient(ellipse 1200px 800px at 50% 0%, rgba(201, 162, 39, 0.08) 0%, transparent 60%),
        radial-gradient(ellipse 800px 600px at 50% 100%, rgba(201, 162, 39, 0.05) 0%, transparent 50%);
      min-height: 100vh;
      color: var(--text);
      display: flex;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background:
        radial-gradient(ellipse 1000px 520px at 20% 15%, rgba(201, 162, 39, 0.07) 0%, transparent 60%),
        radial-gradient(ellipse 900px 480px at 80% 85%, rgba(201, 162, 39, 0.05) 0%, transparent 62%),
        linear-gradient(120deg, rgba(10, 12, 15, 0.0) 0%, rgba(201, 162, 39, 0.03) 50%, rgba(10, 12, 15, 0.0) 100%);
      background-size: 140% 140%, 140% 140%, 220% 220%;
      background-position: 0% 0%, 100% 100%, 50% 50%;
      opacity: 0.9;
      transform: translateZ(0);
      animation: bg-drift 28s ease-in-out infinite;
    }

    @keyframes bg-drift {
      0% { background-position: 0% 0%, 100% 100%, 50% 50%; }
      50% { background-position: 18% 10%, 82% 90%, 48% 55%; }
      100% { background-position: 0% 0%, 100% 100%, 50% 50%; }
    }

    /* Dragon silhouettes */
    .dragon {
      position: fixed;
      width: 320px;
      height: 400px;
      background-size: contain;
      background-repeat: no-repeat;
      opacity: 0.04;
      pointer-events: none;
      z-index: 1;
    }

    .dragon.left {
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 150'%3E%3Cpath d='M20 75 Q30 40 50 30 Q70 20 80 40 Q90 60 85 80 Q80 100 60 120 Q40 140 20 130 Q10 120 15 100 Q18 85 20 75Z' fill='%23c9a227'/%3E%3Cpath d='M50 30 Q55 15 70 10 Q80 8 85 15' stroke='%23c9a227' fill='none' stroke-width='3'/%3E%3Cpath d='M80 40 Q95 35 100 45' stroke='%23c9a227' fill='none' stroke-width='2'/%3E%3C/svg%3E");
    }

    .dragon.right {
      right: -60px;
      top: 50%;
      transform: translateY(-50%) scaleX(-1);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 150'%3E%3Cpath d='M20 75 Q30 40 50 30 Q70 20 80 40 Q90 60 85 80 Q80 100 60 120 Q40 140 20 130 Q10 120 15 100 Q18 85 20 75Z' fill='%23c9a227'/%3E%3Cpath d='M50 30 Q55 15 70 10 Q80 8 85 15' stroke='%23c9a227' fill='none' stroke-width='3'/%3E%3Cpath d='M80 40 Q95 35 100 45' stroke='%23c9a227' fill='none' stroke-width='2'/%3E%3C/svg%3E");
    }

    .page {
      flex: 1;
      display: grid;
      place-items: center;
      padding: 32px 20px;
      position: relative;
      z-index: 2;
    }

    .card {
      width: min(620px, 100%);
      position: relative;
      background: linear-gradient(180deg, rgba(17, 20, 24, 0.97) 0%, rgba(10, 12, 15, 0.98) 100%);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 48px 40px;
      text-align: center;
      box-shadow:
        0 0 80px var(--glow),
        0 25px 60px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(201, 162, 39, 0.1);
      isolation: isolate;
      animation: border-pulse 4.8s ease-in-out infinite;
    }

    @keyframes border-pulse {
      0%, 100% {
        box-shadow: 0 0 80px var(--glow), 0 25px 60px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(201, 162, 39, 0.1);
      }
      50% {
        box-shadow: 0 0 95px rgba(201, 162, 39, 0.20), 0 25px 60px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(201, 162, 39, 0.14);
      }
    }

    .card > :not(.romance-layer) {
      position: relative;
      z-index: 1;
    }

    .card::before {
      content: '';
      position: absolute;
      inset: 12px;
      z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cg fill='none' stroke='%23c9a227' stroke-width='2' opacity='0.55'%3E%3Cpath d='M36 40c0-6 5-11 11-11 5 0 10 3 13 7 3-4 8-7 13-7 6 0 11 5 11 11 0 14-24 28-24 28S36 54 36 40z'/%3E%3Cpath d='M78 88c0-4 3-7 7-7 3 0 6 2 7 5 2-3 5-5 8-5 4 0 7 3 7 7 0 9-15 17-15 17S78 97 78 88z'/%3E%3Cpath d='M12 90c0-4 3-7 7-7 3 0 6 2 7 5 2-3 5-5 8-5 4 0 7 3 7 7 0 9-15 17-15 17S12 99 12 90z'/%3E%3C/g%3E%3C/svg%3E");
      background-repeat: repeat;
      background-size: 140px 140px;
      opacity: 0.06;
      pointer-events: none;
      border-radius: 4px;
    }

    .romance-layer {
      position: absolute;
      inset: 10px;
      border-radius: 4px;
      pointer-events: none;
      z-index: 0;
      opacity: 0.65;
      background:
        radial-gradient(circle at 18% 22%, rgba(232, 212, 139, 0.18) 0 2px, transparent 3px),
        radial-gradient(circle at 78% 28%, rgba(201, 162, 39, 0.14) 0 1.5px, transparent 3px),
        radial-gradient(circle at 32% 74%, rgba(232, 212, 139, 0.12) 0 1.5px, transparent 3px),
        radial-gradient(circle at 62% 72%, rgba(201, 162, 39, 0.12) 0 2px, transparent 3px),
        radial-gradient(circle at 48% 40%, rgba(232, 212, 139, 0.10) 0 1.2px, transparent 3px);
      transform: translateZ(0);
      animation: romance-drift 16s ease-in-out infinite;
      mask-image: radial-gradient(ellipse 70% 60% at 50% 42%, rgba(0,0,0,1) 0%, rgba(0,0,0,0.85) 60%, rgba(0,0,0,0.0) 100%);
    }

    @keyframes romance-drift {
      0% { background-position: 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%; }
      50% { background-position: 0% 10%, 0% -8%, 0% 8%, 0% -12%, 0% 6%; }
      100% { background-position: 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%; }
    }

    /* Corner ornaments */
    .corner {
      position: absolute;
      width: 50px;
      height: 50px;
      border-color: var(--gold);
      border-style: solid;
      opacity: 0.5;
      z-index: 2;
    }

    .corner.tl {
      top: 12px;
      left: 12px;
      border-width: 2px 0 0 2px;
    }

    .corner.tr {
      top: 12px;
      right: 12px;
      border-width: 2px 2px 0 0;
    }

    .corner.bl {
      bottom: 12px;
      left: 12px;
      border-width: 0 0 2px 2px;
    }

    .corner.br {
      bottom: 12px;
      right: 12px;
      border-width: 0 2px 2px 0;
    }

    /* Dividers */
    .divider {
      width: 200px;
      height: 20px;
      margin: 0 auto 20px;
      color: var(--gold);
      opacity: 0.6;
    }

    .divider.small {
      width: 120px;
      height: 12px;
      margin: 8px auto 16px;
    }

    .divider svg {
      width: 100%;
      height: 100%;
    }

    .tag {
      font-family: 'Cinzel', Georgia, serif;
      font-size: 0.85rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--gold);
      opacity: 0.7;
      margin-bottom: 16px;
    }

    .hint {
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .meme {
      min-height: 1.6em;
      transition: opacity 220ms ease, transform 220ms ease;
    }

    .meme.is-fading {
      opacity: 0;
      transform: translateY(2px);
    }

    h1 {
      font-family: 'Cinzel Decorative', 'Cinzel', Georgia, serif;
      font-weight: 400;
      font-size: clamp(1.8rem, 4.5vw, 2.8rem);
      letter-spacing: 0.08em;
      color: var(--gold-light);
      text-shadow:
        0 0 40px rgba(201, 162, 39, 0.4),
        0 2px 0 rgba(0, 0, 0, 0.3);
      margin-bottom: 8px;
    }

    .sub {
      font-size: 1.15rem;
      line-height: 1.7;
      color: var(--text);
      max-width: 420px;
      margin: 0 auto 28px;
      font-style: italic;
    }

    .stage {
      position: relative;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin: 0 auto 20px;
      padding: 16px 24px;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.5) 100%);
      border: 1px solid rgba(201, 162, 39, 0.15);
      border-radius: 4px;
      overflow: hidden;
    }

    .stage::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse 300px 100px at 50% 0%, rgba(201, 162, 39, 0.08) 0%, transparent 70%);
      pointer-events: none;
    }

    .btn {
      position: relative;
      z-index: 1;
      appearance: none;
      border: 1px solid var(--gold);
      background: transparent;
      padding: 14px 32px;
      font-family: 'Cinzel', Georgia, serif;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 200ms ease;
      user-select: none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-yes {
      background: linear-gradient(180deg, var(--gold) 0%, var(--gold-dark) 100%);
      color: #0a0c0f;
      border-color: var(--gold-light);
      box-shadow:
        0 0 20px rgba(201, 162, 39, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .btn-yes:hover {
      background: linear-gradient(180deg, var(--gold-light) 0%, var(--gold) 100%);
      box-shadow:
        0 0 30px rgba(201, 162, 39, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    @keyframes heartbeat {
      0% { transform: translateY(-2px) scale(1); }
      20% { transform: translateY(-2px) scale(1.06); }
      40% { transform: translateY(-2px) scale(1); }
      60% { transform: translateY(-2px) scale(1.05); }
      100% { transform: translateY(-2px) scale(1); }
    }

    .btn-yes:hover,
    .btn-yes:focus-visible,
    .btn-yes.is-heartbeat {
      animation: heartbeat 1.15s ease-in-out infinite;
    }

    .btn-no {
      color: var(--text-muted);
      border-color: rgba(212, 207, 196, 0.3);
    }

    .btn-no:hover {
      color: var(--text);
      border-color: rgba(212, 207, 196, 0.5);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .result {
      min-height: 1.5em;
      font-family: 'Cinzel', Georgia, serif;
      font-size: 1.2rem;
      color: var(--gold-light);
      text-shadow: 0 0 20px rgba(201, 162, 39, 0.5);
      margin-bottom: 12px;
    }

    /* Success overlay */
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      padding: 24px;
      z-index: 50;
      background:
        radial-gradient(ellipse 900px 520px at 50% 20%, rgba(201, 162, 39, 0.18) 0%, transparent 60%),
        radial-gradient(ellipse 700px 420px at 50% 90%, rgba(201, 162, 39, 0.10) 0%, transparent 58%),
        rgba(0, 0, 0, 0.82);
      backdrop-filter: blur(6px);
    }

    .overlay.is-open {
      display: grid;
    }

    .confetti {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .overlay-panel {
      width: min(860px, 100%);
      border: 1px solid rgba(201, 162, 39, 0.28);
      background: linear-gradient(180deg, rgba(17, 20, 24, 0.94) 0%, rgba(10, 12, 15, 0.98) 100%);
      box-shadow:
        0 0 110px rgba(201, 162, 39, 0.18),
        0 30px 90px rgba(0, 0, 0, 0.65);
      border-radius: 6px;
      padding: 44px 28px;
      text-align: center;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .overlay-panel::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        radial-gradient(ellipse 420px 180px at 50% 0%, rgba(201, 162, 39, 0.16) 0%, transparent 70%),
        linear-gradient(90deg, rgba(201, 162, 39, 0.0) 0%, rgba(201, 162, 39, 0.08) 50%, rgba(201, 162, 39, 0.0) 100%);
      opacity: 0.7;
      pointer-events: none;
      animation: shimmer 2.4s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { transform: translateY(-8px); opacity: 0.55; }
      50% { transform: translateY(0px); opacity: 0.85; }
      100% { transform: translateY(-8px); opacity: 0.55; }
    }

    .overlay-title {
      position: relative;
      z-index: 1;
      font-family: 'Cinzel Decorative', 'Cinzel', Georgia, serif;
      font-weight: 700;
      font-size: clamp(2.2rem, 6vw, 4rem);
      letter-spacing: 0.06em;
      color: var(--gold-light);
      text-shadow:
        0 0 40px rgba(201, 162, 39, 0.45),
        0 2px 0 rgba(0, 0, 0, 0.35);
      margin-bottom: 26px;
      animation: pop 520ms cubic-bezier(.2,.9,.2,1) both;
    }

    .overlay-title.boom {
      animation: boom 700ms cubic-bezier(.2,.9,.2,1) both;
    }

    @keyframes boom {
      0% { transform: scale(0.94); opacity: 0; }
      40% { transform: scale(1.12); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .overlay-subtitle {
      position: relative;
      z-index: 1;
      font-family: 'Cinzel', Georgia, serif;
      font-size: clamp(1.05rem, 3.8vw, 1.6rem);
      letter-spacing: 0.06em;
      color: var(--text);
      opacity: 0.92;
      text-shadow: 0 0 18px rgba(201, 162, 39, 0.22);
    }

    @keyframes pop {
      0% { transform: scale(0.92); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    @media (prefers-reduced-motion: reduce) {
      body::before,
      .card,
      .romance-layer,
      .overlay-panel::before,
      .overlay-title,
      .btn-yes {
        animation: none;
      }

      .meme {
        transition: none;
      }
    }

    @media (max-width: 500px) {
      .card {
        padding: 42px 24px;
      }

      .corner {
        width: 35px;
        height: 35px;
      }

      h1 {
        letter-spacing: 0.04em;
      }

      .stage {
        height: 104px;
        gap: 16px;
      }

      .btn {
        padding: 12px 24px;
        font-size: 0.9rem;
      }

      .overlay {
        padding: 16px;
      }

      .overlay-panel {
        padding: 34px 18px;
      }

      .dragon {
        display: none;
      }
    }

    @media (max-width: 420px) {
      .sub {
        font-size: 1.22rem;
      }

      .stage {
        flex-direction: column;
        height: 176px;
        gap: 12px;
        padding: 14px 16px;
      }

      .btn {
        width: min(280px, 100%);
      }
    }

    @media (max-width: 360px) {
      .stage {
        height: 190px;
        gap: 12px;
      }

      .btn {
        padding: 12px 18px;
        letter-spacing: 0.08em;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .btn {
        transition: none;
      }
    }
  </style>
</head>
<body>
  <div class="dragon left" aria-hidden="true"></div>
  <div class="dragon right" aria-hidden="true"></div>

  <main class="page">
    <section class="card" aria-labelledby="titulo">
      <div class="romance-layer" aria-hidden="true"></div>
      <div class="corner tl" aria-hidden="true"></div>
      <div class="corner tr" aria-hidden="true"></div>
      <div class="corner bl" aria-hidden="true"></div>
      <div class="corner br" aria-hidden="true"></div>

      <div class="divider" aria-hidden="true">
        <svg viewBox="0 0 200 20" preserveAspectRatio="none">
          <path d="M0 10 Q50 0, 100 10 T200 10" fill="none" stroke="currentColor" stroke-width="1.5"/>
        </svg>
      </div>

      <div class="tag">Modo confesiÃ³n: activado</div>
      <h1 id="titulo">Â¿Quieres ser mi novia? ðŸ¥º</h1>

      <div class="divider small" aria-hidden="true">
        <svg viewBox="0 0 120 12" preserveAspectRatio="none">
          <path d="M0 6 L40 6 M80 6 L120 6" stroke="currentColor" stroke-width="1"/>
          <circle cx="60" cy="6" r="4" fill="currentColor"/>
        </svg>
      </div>

      <p id="sub" class="sub">
        Prometo risas, abrazos y aventurasâ€¦<br>
        Â¿te animas a ser mi compaÃ±era favorita?
      </p>

      <div class="stage" aria-describedby="sub">
        <button id="yesBtn" class="btn btn-yes" type="button">SÃ­, mi amor</button>
        <button id="noBtn" class="btn btn-no" type="button" aria-label="No">No</button>
      </div>

      <p id="memeLine" class="hint meme" aria-live="polite"></p>

      <p id="result" class="result" role="status" aria-live="polite"></p>

      <div class="divider" aria-hidden="true">
        <svg viewBox="0 0 200 20" preserveAspectRatio="none">
          <path d="M0 10 Q50 20, 100 10 T200 10" fill="none" stroke="currentColor" stroke-width="1.5"/>
        </svg>
      </div>
    </section>
  </main>

  <section id="successOverlay" class="overlay" aria-live="polite" aria-label="CelebraciÃ³n" hidden>
    <canvas id="confetti" class="confetti" aria-hidden="true"></canvas>
    <div class="overlay-panel">
      <div id="overlayTitle" class="overlay-title">Papure pa pa pure ðŸ’ƒðŸŽ¶</div>
      <div class="overlay-subtitle">Ya es oficial: ahora eres mi persona favorita ðŸ’›</div>
    </div>
  </section>

  <script>
    const stage = document.querySelector('.stage');
    const yesBtn = document.getElementById('yesBtn');
    const noBtn = document.getElementById('noBtn');
    const result = document.getElementById('result');
    const successOverlay = document.getElementById('successOverlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const confettiCanvas = document.getElementById('confetti');
    const memeLine = document.getElementById('memeLine');

    let noIsAbsolute = false;

    const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let confettiRaf = 0;
    let confettiParticles = [];
    let confettiEndAt = 0;

    const memes = [
      'â€œNoâ€ no es opciÃ³n, es decoraciÃ³n âœ¨',
      'El â€œNoâ€ se bugueÃ³ de amorâ€¦ perdÃ³n ðŸ˜Œ',
      'Si intentas â€œNoâ€â€¦ se te escapa por respeto a tu belleza ðŸ’›',
    ];

    let memeIndex = Math.floor(Math.random() * memes.length);
    let memeTimer = 0;

    function setMeme(text) {
      if (!memeLine) return;
      memeLine.classList.add('is-fading');
      window.setTimeout(() => {
        memeLine.textContent = text;
        memeLine.classList.remove('is-fading');
      }, prefersReducedMotion ? 0 : 170);
    }

    function startMemeRotation() {
      if (!memeLine) return;
      setMeme(memes[memeIndex]);
      if (prefersReducedMotion) return;
      if (memeTimer) window.clearInterval(memeTimer);
      memeTimer = window.setInterval(() => {
        memeIndex = (memeIndex + 1) % memes.length;
        setMeme(memes[memeIndex]);
      }, 2600);
    }

    function resizeConfettiCanvas() {
      if (!confettiCanvas) return;
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const rect = successOverlay.getBoundingClientRect();
      confettiCanvas.width = Math.floor(rect.width * dpr);
      confettiCanvas.height = Math.floor(rect.height * dpr);
      confettiCanvas.style.width = `${rect.width}px`;
      confettiCanvas.style.height = `${rect.height}px`;

      const ctx = confettiCanvas.getContext('2d');
      if (ctx) ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function stopConfetti() {
      if (confettiRaf) cancelAnimationFrame(confettiRaf);
      confettiRaf = 0;
      confettiParticles = [];
      confettiEndAt = 0;
      if (confettiCanvas) {
        const ctx = confettiCanvas.getContext('2d');
        if (ctx) ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      }
    }

    function startConfetti(options = {}) {
      if (prefersReducedMotion) return;
      if (!confettiCanvas) return;

      const durationMs = typeof options === 'number' ? options : (options.durationMs ?? 2200);
      const density = typeof options === 'object' ? (options.density ?? 1) : 1;

      stopConfetti();
      resizeConfettiCanvas();

      const rect = successOverlay.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      const colors = ['#c9a227', '#e8d48b', '#8b6914', '#d4cfc4'];
      const base = Math.round(Math.min(160, Math.max(80, (w * h) / 12000)));
      const count = Math.round(Math.min(280, Math.max(80, base * density)));

      const rand = (min, max) => min + Math.random() * (max - min);
      confettiParticles = Array.from({ length: count }, () => {
        const size = rand(5, 10);
        return {
          x: rand(0, w),
          y: rand(-h * 0.2, -10),
          vx: rand(-55, 55),
          vy: rand(140, 320),
          g: rand(420, 680),
          size,
          rot: rand(0, Math.PI * 2),
          vr: rand(-8, 8),
          color: colors[(Math.random() * colors.length) | 0],
          shape: Math.random() < 0.25 ? 'ribbon' : 'rect',
        };
      });

      const ctx = confettiCanvas.getContext('2d');
      if (!ctx) return;

      confettiEndAt = performance.now() + durationMs;
      let last = performance.now();

      function tick(now) {
        const dt = Math.min(0.032, (now - last) / 1000);
        last = now;

        ctx.clearRect(0, 0, w, h);

        for (const p of confettiParticles) {
          p.vy += p.g * dt;
          p.x += p.vx * dt;
          p.y += p.vy * dt;
          p.rot += p.vr * dt;

          if (p.x < -30) p.x = w + 30;
          if (p.x > w + 30) p.x = -30;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.color;

          if (p.shape === 'ribbon') {
            ctx.globalAlpha = 0.95;
            ctx.fillRect(-p.size * 0.25, -p.size * 1.2, p.size * 0.5, p.size * 2.4);
          } else {
            ctx.globalAlpha = 0.9;
            ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
          }

          ctx.restore();
        }

        if (now < confettiEndAt) {
          confettiRaf = requestAnimationFrame(tick);
        } else {
          stopConfetti();
        }
      }

      confettiRaf = requestAnimationFrame(tick);
    }

    function boomOverlayTitle() {
      if (!overlayTitle) return;
      overlayTitle.classList.remove('boom');
      void overlayTitle.offsetWidth;
      overlayTitle.classList.add('boom');
    }

    function pulseYesButton() {
      if (prefersReducedMotion) return;
      yesBtn.classList.add('is-heartbeat');
      window.setTimeout(() => yesBtn.classList.remove('is-heartbeat'), 900);
    }

    yesBtn.addEventListener('pointerdown', () => {
      if (yesBtn.disabled) return;
      pulseYesButton();
    });

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    function makeNoAbsoluteAtCurrentPosition() {
      if (noIsAbsolute) return;

      const stageRect = stage.getBoundingClientRect();
      const noRect = noBtn.getBoundingClientRect();

      const left = noRect.left - stageRect.left;
      const top = noRect.top - stageRect.top;

      noBtn.style.position = 'absolute';
      noBtn.style.left = `${left}px`;
      noBtn.style.top = `${top}px`;

      noIsAbsolute = true;
    }

    function rectsOverlap(a, b) {
      return !(
        a.x + a.w <= b.x ||
        b.x + b.w <= a.x ||
        a.y + a.h <= b.y ||
        b.y + b.h <= a.y
      );
    }

    function expandRect(rect, amount) {
      return {
        x: rect.x - amount,
        y: rect.y - amount,
        w: rect.w + amount * 2,
        h: rect.h + amount * 2,
      };
    }

    function moveNoSomewhereElse() {
      makeNoAbsoluteAtCurrentPosition();

      const stageRect = stage.getBoundingClientRect();
      const noRect = noBtn.getBoundingClientRect();
      const yesRect = yesBtn.getBoundingClientRect();

      const yesInStage = {
        x: yesRect.left - stageRect.left,
        y: yesRect.top - stageRect.top,
        w: yesRect.width,
        h: yesRect.height,
      };
      const avoidYes = expandRect(yesInStage, 12);

      const padding = 8;
      const maxLeft = Math.max(padding, stageRect.width - noRect.width - padding);
      const maxTop = Math.max(padding, stageRect.height - noRect.height - padding);

      function candidateAt(x, y) {
        return { x, y, w: noRect.width, h: noRect.height };
      }

      let chosen = null;
      for (let i = 0; i < 30; i++) {
        const nextLeft = clamp(
          Math.random() * (stageRect.width - noRect.width),
          padding,
          maxLeft
        );
        const nextTop = clamp(
          Math.random() * (stageRect.height - noRect.height),
          padding,
          maxTop
        );

        const cand = candidateAt(nextLeft, nextTop);
        if (!rectsOverlap(cand, avoidYes)) {
          chosen = cand;
          break;
        }
      }

      if (!chosen) {
        const corners = [
          candidateAt(padding, padding),
          candidateAt(maxLeft, padding),
          candidateAt(padding, maxTop),
          candidateAt(maxLeft, maxTop),
        ];

        const ok = corners.filter((c) => !rectsOverlap(c, avoidYes));
        const candidates = ok.length ? ok : corners;

        const yesCenter = {
          x: yesInStage.x + yesInStage.w / 2,
          y: yesInStage.y + yesInStage.h / 2,
        };

        chosen = candidates
          .map((c) => {
            const cx = c.x + c.w / 2;
            const cy = c.y + c.h / 2;
            const dx = cx - yesCenter.x;
            const dy = cy - yesCenter.y;
            return { c, score: dx * dx + dy * dy };
          })
          .sort((a, b) => b.score - a.score)[0].c;
      }

      noBtn.style.left = `${chosen.x}px`;
      noBtn.style.top = `${chosen.y}px`;
    }

    ['pointerenter', 'mouseover', 'touchstart'].forEach((evt) => {
      noBtn.addEventListener(evt, (e) => {
        if (evt === 'touchstart') e.preventDefault();
        moveNoSomewhereElse();
      }, { passive: false });
    });

    noBtn.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      moveNoSomewhereElse();
    });

    noBtn.addEventListener('click', (e) => {
      e.preventDefault();
      moveNoSomewhereElse();
    });

    yesBtn.addEventListener('click', () => {
      const msg = 'Papure pa pa pure ðŸ’ƒðŸŽ¶';
      result.textContent = msg;
      overlayTitle.textContent = msg;

      successOverlay.hidden = false;
      successOverlay.classList.add('is-open');
      document.body.style.overflow = 'hidden';

      if (navigator.vibrate) {
        navigator.vibrate([18, 24, 18]);
      }

      boomOverlayTitle();
      startConfetti({ durationMs: 1000, density: 2.2 });

      yesBtn.disabled = true;
      noBtn.disabled = true;
      yesBtn.style.cursor = 'default';
      noBtn.style.cursor = 'default';
    });

    window.addEventListener('resize', () => {
      if (!noIsAbsolute) return;
      moveNoSomewhereElse();
    });

    window.addEventListener('resize', () => {
      if (successOverlay.hidden) return;
      resizeConfettiCanvas();
    });

    startMemeRotation();
  </script>
</body>
</html>
